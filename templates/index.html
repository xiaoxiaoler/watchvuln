<!doctype html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>漏洞情报狩猎 本地漏洞列表</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>漏洞情报狩猎 本地漏洞列表</h1>
      <div class="meta">
        API: <a href="/api/vulns" target="_blank">/api/vulns</a>
      </div>
    </div>
    
    <div class="search-container">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="搜索漏洞标题或CVE编号...">
        <button onclick="performSearch()">搜索</button>
      </div>
      
      <div class="filters-container">
        <div class="filter-group">
          <label>披露时间:</label>
          <input type="date" id="disclosureStart" placeholder="开始日期">
          <span>至</span>
          <input type="date" id="disclosureEnd" placeholder="结束日期">
        </div>
        
        <div class="filter-group">
          <label>更新时间:</label>
          <input type="date" id="updateStart" placeholder="开始日期">
          <span>至</span>
          <input type="date" id="updateEnd" placeholder="结束日期">
        </div>
        
        <div class="filter-group">
        <label>已推送:</label>
        <select id="pushedFilter">
          <option value="">全部</option>
          <option value="true">是</option>
          <option value="false">否</option>
        </select>
      </div>
      
      <div class="filter-group severity-filter">
        <label>严重性:</label>
        <label class="checkbox-label">
          <input type="checkbox" name="severity" value="严重" checked>
          <span>严重</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="severity" value="高危" checked>
          <span>高危</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="severity" value="中危" checked>
          <span>中危</span>
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="severity" value="低危" checked>
          <span>低危</span>
        </label>
      </div>
        
        <button class="filter-btn" onclick="performSearch()">应用筛选</button>
        <button class="filter-btn clear" onclick="clearFilters()">清除筛选</button>
      </div>
    </div>
    
    <div class="stats">
      <span id="totalCount">共 {{.total}} 条</span>
      <span id="displayCount" style="margin-left: 15px;">显示 {{len .vulns}} 条</span>
      <span style="margin-left: 15px;">第 {{.page}} / {{.totalPages}} 页</span>
    </div>
    
    <div class="table-container">
      <table id="vulnTable">
        <thead>
          <tr>
            <th>标题</th>
            <th>严重性</th>
            <th>CVE</th>
            <th>披露日期</th>
            <th>来源</th>
            <th>标签</th>
            <th>已推送</th>
            <th>更新时间</th>
          </tr>
        </thead>
        <tbody>
        {{range .vulns}}
          <tr>
            <td class="title-cell">
              <div><strong>{{.Title}}</strong></div>
              <div class="from"><a href="{{.From}}" target="_blank">{{.From}}</a></div>
            </td>
            <td class="severity-{{.Severity}}">{{.Severity}}</td>
            <td class="cve-cell">{{.Cve}}</td>
            <td class="date-cell">{{.Disclosure}}</td>
            <td>{{.Key}}</td>
            <td>{{range .Tags}}<span class="tag">{{.}}</span>{{end}}</td>
            <td class="{{if .Pushed}}pushed-yes{{else}}pushed-no{{end}}">{{if .Pushed}}是{{else}}否{{end}}</td>
            <td class="date-cell">{{.UpdateTime.Format "2006-01-02 15:04:05"}}</td>
          </tr>
        {{end}}
        </tbody>
      </table>
    </div>
    
    <div class="pagination-container">
      <div class="pagination">
        <button 
          onclick="changePage(1)" 
          {{if eq .page 1}}disabled{{end}}
          class="page-btn"
        >
          首页
        </button>
        <button 
          onclick="changePageToPrevious()" 
          {{if eq .page 1}}disabled{{end}}
          class="page-btn"
        >
          上一页
        </button>
        
        <div class="page-input-group">
          <span>第</span>
          <input 
            type="number" 
            id="currentPageInput" 
            value="{{.page}}" 
            min="1" 
            max="{{.totalPages}}" 
            onkeypress="if(event.key==='Enter') { goToPage() }"
          >
          <span>页 / 共 {{.totalPages}} 页</span>
        </div>
        
        <button 
          onclick="changePageToNext()" 
          {{if eq .page .totalPages}}disabled{{end}}
          class="page-btn"
        >
          下一页
        </button>
        <button 
          onclick="changePage({{.totalPages}})" 
          {{if eq .page .totalPages}}disabled{{end}}
          class="page-btn"
        >
          末页
        </button>
        
        <div class="page-size-selector">
          <span>每页显示</span>
          <select 
            id="pageSizeSelect" 
            onchange="changePageSize()"
          >
            <option {{if eq .pageSize 10}}selected{{end}} value="10">10</option>
            <option {{if eq .pageSize 20}}selected{{end}} value="20">20</option>
            <option {{if eq .pageSize 50}}selected{{end}} value="50">50</option>
            <option {{if eq .pageSize 100}}selected{{end}} value="100">100</option>
          </select>
          <span>条</span>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // 列宽拉拽功能
    function initColumnResizing() {
      const table = document.getElementById('vulnTable');
      const headers = table.querySelectorAll('th');
      
      headers.forEach((header, index) => {
        let isResizing = false;
        let startX;
        let startWidth;
        
        header.addEventListener('mousedown', (e) => {
          // 只在点击列边界时触发拉拽
          if (e.offsetX > header.offsetWidth - 10) {
            isResizing = true;
            startX = e.clientX;
            startWidth = header.offsetWidth;
            document.body.classList.add('resizing');
            e.preventDefault();
          }
        });
        
        document.addEventListener('mousemove', (e) => {
          if (!isResizing) return;
          
          const deltaX = e.clientX - startX;
          const newWidth = startWidth + deltaX;
          
          // 设置最小宽度
          if (newWidth < 100) return;
          
          // 更新表头宽度
          header.style.width = newWidth + 'px';
          
          // 更新所有行的对应列宽度
          const rows = table.querySelectorAll('tr');
          rows.forEach(row => {
            const cell = row.cells[index];
            if (cell) {
              cell.style.width = newWidth + 'px';
            }
          });
        });
        
        document.addEventListener('mouseup', () => {
          isResizing = false;
          document.body.classList.remove('resizing');
        });
      });
    }
    
    // 获取当前URL参数
    function getURLParams() {
      const params = new URLSearchParams(window.location.search);
      return params;
    }
    
    // 构建带参数的URL
    function buildURL(page, pageSize) {
      const params = getURLParams();
      
      // 设置分页参数
      params.set('page', page);
      params.set('pageSize', pageSize);
      
      // 设置搜索参数
      const searchTerm = document.getElementById('searchInput').value.trim();
      if (searchTerm) {
        params.set('search', searchTerm);
      } else {
        params.delete('search');
      }
      
      // 设置披露日期参数
      const disclosureStart = document.getElementById('disclosureStart').value;
      if (disclosureStart) {
        params.set('disclosure_start', disclosureStart);
      } else {
        params.delete('disclosure_start');
      }
      
      const disclosureEnd = document.getElementById('disclosureEnd').value;
      if (disclosureEnd) {
        params.set('disclosure_end', disclosureEnd);
      } else {
        params.delete('disclosure_end');
      }
      
      // 设置更新日期参数
      const updateStart = document.getElementById('updateStart').value;
      if (updateStart) {
        params.set('update_start', updateStart);
      } else {
        params.delete('update_start');
      }
      
      const updateEnd = document.getElementById('updateEnd').value;
      if (updateEnd) {
        params.set('update_end', updateEnd);
      } else {
        params.delete('update_end');
      }
      
      // 设置推送状态参数
      const pushedFilter = document.getElementById('pushedFilter').value;
      if (pushedFilter) {
        params.set('pushed', pushedFilter);
      } else {
        params.delete('pushed');
      }
      
      // 设置严重性参数
      const severityCheckboxes = document.querySelectorAll('input[name="severity"]:checked');
      const selectedSeverities = Array.from(severityCheckboxes).map(cb => cb.value);
      if (selectedSeverities.length > 0) {
        params.set('severities', selectedSeverities.join(','));
      } else {
        params.delete('severities');
      }
      
      return window.location.pathname + '?' + params.toString();
    }
    
    // 页面跳转
    function changePage(page) {
      const pageSize = document.getElementById('pageSizeSelect').value || 20;
      window.location.href = buildURL(page, pageSize);
    }
    
    // 跳转到上一页
    function changePageToPrevious() {
      const currentPage = {{.page}};
      if (currentPage > 1) {
        changePage(currentPage - 1);
      }
    }
    
    // 跳转到下一页
    function changePageToNext() {
      const currentPage = {{.page}};
      const totalPages = {{.totalPages}};
      if (currentPage < totalPages) {
        changePage(currentPage + 1);
      }
    }
    
    // 跳转到指定页码
    function goToPage() {
      const pageInput = document.getElementById('currentPageInput');
      let page = parseInt(pageInput.value);
      if (isNaN(page) || page < 1) {
        page = 1;
      }
      const totalPages = {{.totalPages}};
      if (page > totalPages) {
        page = totalPages;
      }
      changePage(page);
    }
    
    // 改变每页显示数量
    function changePageSize() {
      const pageSize = document.getElementById('pageSizeSelect').value;
      // 重新从第一页开始
      window.location.href = buildURL(1, pageSize);
    }
    
    function performSearch() {
      // 搜索时从第一页开始
      const pageSize = document.getElementById('pageSizeSelect').value || 20;
      window.location.href = buildURL(1, pageSize);
    }
    
    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('disclosureStart').value = '';
      document.getElementById('disclosureEnd').value = '';
      document.getElementById('updateStart').value = '';
      document.getElementById('updateEnd').value = '';
      document.getElementById('pushedFilter').value = '';
      
      // 重置所有严重性复选框为选中状态
      const severityCheckboxes = document.querySelectorAll('input[name="severity"]');
      severityCheckboxes.forEach(cb => cb.checked = true);
      
      // 清除后从第一页开始
      const pageSize = document.getElementById('pageSizeSelect').value || 20;
      window.location.href = buildURL(1, pageSize);
    }
    
    // 页面加载时初始化筛选条件
    window.addEventListener('load', function() {
      // 从URL参数中恢复筛选条件
      const params = getURLParams();
      
      // 恢复搜索条件
      const search = params.get('search');
      if (search) {
        document.getElementById('searchInput').value = search;
      }
      
      // 恢复披露日期条件
      const disclosureStart = params.get('disclosure_start');
      if (disclosureStart) {
        document.getElementById('disclosureStart').value = disclosureStart;
      }
      
      const disclosureEnd = params.get('disclosure_end');
      if (disclosureEnd) {
        document.getElementById('disclosureEnd').value = disclosureEnd;
      }
      
      // 恢复更新日期条件
      const updateStart = params.get('update_start');
      if (updateStart) {
        document.getElementById('updateStart').value = updateStart;
      }
      
      const updateEnd = params.get('update_end');
      if (updateEnd) {
        document.getElementById('updateEnd').value = updateEnd;
      }
      
      // 恢复推送状态条件
      const pushed = params.get('pushed');
      if (pushed) {
        document.getElementById('pushedFilter').value = pushed;
      }
      
      // 恢复严重性条件
      const severities = params.get('severities');
      if (severities) {
        const selectedSeverities = severities.split(',');
        const checkboxes = document.querySelectorAll('input[name="severity"]');
        checkboxes.forEach(cb => {
          cb.checked = selectedSeverities.includes(cb.value);
        });
      }
      
      // 初始化列宽拉拽
      initColumnResizing();
    });
    
    // 监听回车键
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        performSearch();
      }
    });
    
    // 页面加载时初始化列宽拉拽
    window.addEventListener('load', function() {
      initColumnResizing();
    });
  </script>
</body>
</html>